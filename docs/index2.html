<!-- Add paper print facility -->

<head>
<!-- Load plotly.js into the DOM -->
<script src='https://cdn.plot.ly/plotly-latest.min.js'></script>
</head>

<body>

  <H1> Performance Test </H1>
  <select name="metric" id="metric">
    <option value="Solve">Solve</option>
    <option value="Assemble matrix">Assemble matrix</option>
    <option value="Assemble vector">Assemble vector</option>
    <option value="Create Mesh">Create mesh</option>
  </select>
  <div id='PoissonDiv'></div>
  <div id='ElasticDiv'></div>

<script>

var saved_dir;
var performance_data = [];

function fetch_data(filename)
{
    fetch('https://raw.githubusercontent.com/FEniCS/performance-test-results/master/results/' + filename)
	.then((response) => {
	    return response.json();
	})
	.then((data) => {
		temp_data = [];
	    temp_data.push(data);
		var all_data = [];

		// Temp data is separated into several individual arrays, so combine this all
		// together.
		for (i=0; i<temp_data.length;i++)
		{
			for (j=0; j<temp_data[i].length;j++)
			{
				performance_data.push(temp_data[i][j])
			}
		}
	});
}

function page_boot()
{
    // Get directory listing and fetch data
    fetch('https://api.github.com/repos/FEniCS/performance-test-results/contents/results')
	.then((response) => {
	    return response.json();
	})
	.then((jsonDirectory) => {
	    saved_dir = jsonDirectory;
	    for (var key in saved_dir){
		fetch_data(saved_dir[key]['name']);
	    }
	});
}

function replot()
{
	console.log(performance_data);
    var metric_selector = document.getElementById("metric");
    var metric = metric_selector.value

    var layout_e = {
	barmode: 'group',
	title: {text: 'Run time: '+metric+' (Elastic)'},
	xaxis: {title: {text: 'Nodes'}},
	yaxis: {title: {text: 'time (s)'}}
    };
    var layout_p = {
	barmode: 'group',
	title: {text: 'Run time: '+metric+' (Poisson)'},
	xaxis: {title: {text: 'Nodes'}},
	yaxis: {title: {text: 'time (s)'}}
    };

    var traces = {Poisson:[],
		  Elastic:[]};

	// var result = Object.values(record.data).filter(function(x){return x.nodes==1})
	// console.log(result)

	// var result = performance_data.map(x => [x.time, x.data.filter(function(x){return x.nodes==1 && x.problem=="Poisson"})[0][metric]])
	// console.log(result)
	
	var trace = {x: [],
				 y: [],
				 name: record.time}};
	
	trace.x = performance_data.map(x => x.time)
	trace.y = performance_data.map(x => x.data.filter(function(x){return x.nodes==1 && x.problem=="Poisson"})[0][metric])

	// for (i=0; i<performance_data.length; i++)
	// {
	// 	var record = performance_data[i];
	// 	console.log(record.time);
	// 	console.log(record.data);

	// 	var p = {'Poisson': [], 'Elastic': []};
	// 	for (var r in record.data)
	// 	{
	// 		w = record.data[r];
	// 		p[w.problem].push([w.nodes, w[metric]]);
	// 	}
	// 	for (var k in p)
	// 	{
	// 		p[k] = p[k].sort(function(a, b){
	// 			return a[0] - b[0];
	// 		});

	// 		var trace = {x: [],
	// 				y: [],
	// 				type: 'bar',
	// 				name: record.time};

	// 		for (var a in p[k])
	// 		{
	// 			trace.x.push(String(p[k][a][0])+"x");
	// 			trace.y.push(p[k][a][1]);
	// 		}
	// 		traces[k].push(trace);
	// 	}
	// }
	console.log([trace])
    Plotly.newPlot('PoissonDiv', [trace], layout_p);
    Plotly.newPlot('ElasticDiv', traces.Elastic, layout_e);

}

var metric_selector = document.getElementById("metric");
window.onload = page_boot; // Any reason for not just calling page_boot?
metric_selector.onchange = replot;

</script>
</body>
